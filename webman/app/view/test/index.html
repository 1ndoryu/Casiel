<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Casiel - Suite de Pruebas de Integración</title>
        <style>
            body {
                background-color: #1a1a1a;
                color: #e0e0e0;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
                margin: 0;
                padding: 2rem;
                line-height: 1.6;
            }
            .container {
                max-width: 900px;
                margin: 0 auto;
            }
            h1,
            h2 {
                color: #ffffff;
                border-bottom: 1px solid #444;
                padding-bottom: 0.5rem;
                font-weight: 500;
            }
            .test-controls {
                background-color: #252525;
                border: 1px solid #444;
                padding: 1.5rem;
                border-radius: 5px;
                margin-bottom: 2rem;
            }
            .form-group {
                margin-bottom: 1rem;
            }
            label {
                display: block;
                margin-bottom: 0.5rem;
                color: #ccc;
            }
            input[type='text'],
            input[type='password'] {
                width: 100%;
                padding: 10px;
                background-color: #333;
                border: 1px solid #555;
                border-radius: 4px;
                color: #e0e0e0;
                font-size: 1rem;
                box-sizing: border-box;
            }
            button {
                background-color: #28a745;
                color: white;
                width: 100%;
                border: none;
                padding: 12px 20px;
                font-size: 1.1rem;
                border-radius: 5px;
                cursor: pointer;
                transition: background-color 0.2s;
                font-weight: bold;
            }
            button:hover {
                filter: brightness(1.2);
            }
            button:disabled {
                background-color: #555;
                cursor: not-allowed;
                filter: none;
            }
            pre {
                background-color: #252525;
                border: 1px solid #444;
                padding: 1rem;
                border-radius: 5px;
                white-space: pre-wrap;
                word-wrap: break-word;
                font-size: 0.9rem;
                color: #d1d1d1;
                max-height: 70vh;
                overflow-y: auto;
            }
            .error-log {
                color: #ff8c8c !important;
                border-color: #933 !important;
            }
            .success-log {
                 color: #a7fca7 !important;
                 border-color: #393 !important;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>Casiel - Suite de Pruebas de Integración</h1>

            <div class="test-controls">
                <h2>Configuración de Prueba</h2>
                <div class="form-group">
                    <label for="sword-url">URL API de Sword (Ej: http://localhost:8787/api/v1/)</label>
                    <input type="text" id="sword-url" value="<?= htmlspecialchars($sword_url) ?>" />
                </div>
                <div class="form-group">
                    <label for="sword-key">API Key de Sword</label>
                    <input type="password" id="sword-key" value="<?= htmlspecialchars($sword_key) ?>" />
                </div>
                <button id="run-full-test">▶️ Ejecutar Test Completo</button>
            </div>

            <h2>Log de Ejecución:</h2>
            <pre id="response-output">
Listo para iniciar el test.
Asegúrate de que el archivo 'webman/tests/fixtures/test.mp3' existe.</pre
            >
        </div>

        <script>
            const runTestBtn = document.getElementById('run-full-test');
            const output = document.getElementById('response-output');
            const swordUrlInput = document.getElementById('sword-url');
            const swordKeyInput = document.getElementById('sword-key');

            runTestBtn.addEventListener('click', function () {
                runTestBtn.disabled = true;
                runTestBtn.textContent = 'Ejecutando...';
                output.textContent = 'Iniciando test de integración. Esto puede tardar unos minutos...';
                output.className = '';

                const formData = new FormData();
                formData.append('sword_url', swordUrlInput.value);
                formData.append('sword_key', swordKeyInput.value);

                fetch('/test/run-full', {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json' // Crucial para que el backend devuelva errores en JSON
                    },
                    body: formData
                })
                .then(response => {
                    const contentType = response.headers.get('content-type');
                    // Si la respuesta es exitosa y es JSON, la procesamos
                    if (response.ok && contentType && contentType.includes('application/json')) {
                        return response.json();
                    }
                    // Si no, es un error. Obtenemos el cuerpo como texto para mostrarlo.
                    return response.text().then(text => {
                        throw new Error(`La respuesta del servidor no es un JSON válido (Status: ${response.status} ${response.statusText}).\n\nCONTENIDO DE LA RESPUESTA:\n--------------------------------\n${text}`);
                    });
                })
                .then(data => {
                    const log = data.log_ejecucion;
                    // Si el log contiene un error fatal capturado por el backend, lo mostramos en rojo.
                    if (log && log.error_fatal) {
                        output.className = 'error-log';
                        output.textContent = "❌ El test finalizó con un error fatal en el backend:\n\n" + JSON.stringify(log, null, 2);
                    } else {
                        output.className = 'success-log';
                        output.textContent = "✅ Test finalizado. Revisa los logs para ver los detalles:\n\n" + JSON.stringify(data, null, 2);
                    }
                })
                .catch(error => {
                    output.className = 'error-log';
                    // El mensaje de error ahora contiene el texto detallado de la respuesta del servidor
                    output.textContent = '❌ Error crítico en la petición fetch:\n\n' + error.message;
                })
                .finally(() => {
                    runTestBtn.disabled = false;
                    runTestBtn.textContent = '▶️ Ejecutar Test Completo de Nuevo';
                });
            });
        </script>
    </body>
</html>